name: Generate Image JSON

on:
  push:
    paths:
      - "wallpapers/**"

permissions:
  contents: write    # <── REQUIRED for git push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Generate JSON
      run: |
        python3 << 'EOF'
        import os, json

        root = "wallpapers"
        repo = "${{ github.repository }}"
        branch = "main"

        result = []

        for category in os.listdir(root):
            category_path = os.path.join(root, category)
            if not os.path.isdir(category_path):
                continue

            base = f"https://raw.githubusercontent.com/{repo}/{branch}/{root}/{category}/"

            files = []
            for f in os.listdir(category_path):
                if f.lower().endswith((".jpg", ".jpeg", ".png", ".webp")):
                    files.append({
                        "name": f,
                        "url": base + f
                    })

            if files:
                result.append({
                    "category": category,
                    "files": files
                })

        with open("images.json", "w") as out:
            json.dump(result, out, indent=2)

        print("✔ Generated images.json with", len(result), "categories.")
        EOF

    - name: Commit changes
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add images.json
        git commit -m "Auto-update images.json" || echo "No changes to commit"
        git push
